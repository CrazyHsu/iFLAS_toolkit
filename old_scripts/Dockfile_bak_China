FROM ubuntu:16.04
MAINTAINER xufeng <crazyhsu9527@gmail.com>

# install basic dependencies
RUN sed -i s@/archive.ubuntu.com/@/mirrors.tuna.tsinghua.edu.cn/@g /etc/apt/sources.list
RUN apt-get clean && apt-get update && apt-get install -y --no-install-recommends \
	build-essential \
	cmake \
	git \
	wget \
	apt-transport-https \
	libz-dev \
	ca-certificates \
	vim \
	less \
	sudo \
	apt-utils

# install python3.6
RUN apt-get install -y software-properties-common && add-apt-repository -y ppa:deadsnakes/ppa && \
    apt-get update && apt-get install -y python3.6 python3-pip && \
    python3.6 -m pip install pip --upgrade && \
    python3.6 -m pip install wheel

# install albacore
RUN mkdir /.pip && echo "[global]\nindex-url = https://pypi.tuna.tsinghua.edu.cn/simple" > /.pip/pip.conf
RUN wget https://apac.oxfordnanoportal.com/software/analysis/ont_albacore-2.3.4-cp36-cp36m-manylinux1_x86_64.whl && \
    pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple ont_albacore-2.3.4-cp36-cp36m-manylinux1_x86_64.whl && \
    rm -rf ont_albacore-2.3.4-cp36-cp36m-manylinux1_x86_64.whl

ARG UID=1001
ARG GID=1001
RUN groupadd --gid $GID iflas && useradd --uid $UID --gid iflas --shell /bin/bash --create-home iflas
RUN echo "root:123456" | chpasswd
RUN echo "iflas:123456" | chpasswd
USER iflas

ENV IFLAS_HOME /home/iflas

RUN mkdir $IFLAS_HOME/data && mkdir $IFLAS_HOME/software

# install miniconda for python2.7
RUN wget --no-check-certificate https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/Miniconda2-latest-Linux-x86_64.sh -O ~/miniconda2.sh && \
#RUN wget --no-check-certificate https://repo.anaconda.com/miniconda/Miniconda2-latest-Linux-x86_64.sh -O ~/miniconda2.sh && \
	/bin/bash ~/miniconda2.sh -b -p $IFLAS_HOME/software/conda && \
	rm ~/miniconda2.sh

RUN git config --global http.postBuffer 1000000000 && \
	git clone https://hub.fastgit.org/xiaochuanle/MECAT.git $IFLAS_HOME/software/MECAT
WORKDIR $IFLAS_HOME/software/MECAT
RUN make
ENV PATH=$IFLAS_HOME/software/MECAT/Linux-amd64/bin/:$PATH

RUN wget --no-check-certificate https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8/hdf5-1.8.15-patch1/src/hdf5-1.8.15-patch1.tar.gz -O $IFLAS_HOME/software/hdf5-1.8.15-patch1.tar.gz && \
	tar -xf $IFLAS_HOME/software/hdf5-1.8.15-patch1.tar.gz -C $IFLAS_HOME/software/ && \
	mkdir $IFLAS_HOME/software/hdf5 && rm -rf $IFLAS_HOME/software/hdf5-1.8.15-patch1.tar.gz

WORKDIR $IFLAS_HOME/software/hdf5-1.8.15-patch1
RUN ./configure --enable-cxx --prefix=$IFLAS_HOME/software/hdf5 && make && make install

RUN git clone https://hub.fastgit.org/PacificBiosciences/DEXTRACTOR.git $IFLAS_HOME/software/DEXTRACTOR && \
	cp $IFLAS_HOME/software/MECAT/dextract_makefile $IFLAS_HOME/software/DEXTRACTOR

WORKDIR $IFLAS_HOME/software/DEXTRACTOR
ENV HDF5_INCLUDE=$IFLAS_HOME/software/hdf5/include
ENV HDF5_LIB=$IFLAS_HOME/software/hdf5/lib
RUN sed -i '7s/.*/\t${CC} $(CFLAGS) -I$(HDF5_INCLUDE) -L$(HDF5_LIB) -o dextract dextract.c sam.c bax.c expr.c DB.c QV.c -lhdf5 -lz/' dextract_makefile
RUN make -f dextract_makefile

ENV LD_LIBRARY_PATH=$IFLAS_HOME/software/hdf5/lib:$LD_LIBRARY_PATH
ENV PATH=$IFLAS_HOME/software/DEXTRACTOR:$PATH

ENV PATH=$IFLAS_HOME/software/conda/bin:$IFLAS_HOME/software:$PATH

# change conda source for China users
RUN conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/ && \
	conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/ && \
	conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/ && \
	conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda/ && \
	conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r/
#	conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r/ && \
#	conda config --add channels https://mirrors.ustc.edu.cn/anaconda/pkgs/free/ && \
#	conda config --add channels https://mirrors.ustc.edu.cn/anaconda/pkgs/main/ && \
#   conda config --add channels https://mirrors.ustc.edu.cn/anaconda/cloud/bioconda/

RUN sed -i '$d' $IFLAS_HOME/.condarc

RUN conda update --all -y

# create isoseq3 environment with python2.7
RUN conda create -y -n isoseq3_pipeline python=2.7

# set some environment variables
ENV CONDA_DEFAULT_ENV=isoseq3_pipeline
ENV CONDA_PREFIX=$IFLAS_HOME/software/conda/envs/$CONDA_DEFAULT_ENV
ENV CONDA_AUTO_UPDATE_CONDA=false

RUN echo ". $IFLAS_HOME/software/conda/etc/profile.d/conda.sh" >> ~/.bashrc && \
	echo "conda activate isoseq3_pipeline" >> ~/.bashrc

# conda install required packages
RUN conda install -y -c conda-forge r=3.6 perl=5.26.2
RUN conda install -y -c bioconda perl-bioperl perl-app-cpanminus perl-dbi blast subread samtools=1.9 stringtie \
                        minimap2 seqkit hisat2 mash bedtools
RUN conda install -y -c bioconda ucsc-bedtogenepred ucsc-gtftogenepred ucsc-genepredtogtf
RUN conda install -y -c bioconda isoseq3=3.3 bax2bam pbbam=1.0.6 pbcopper=1.3.0 pbccs=4.2 lima pbcoretools rmats=4.0.2
RUN conda install -y -c bioconda bioconductor-deseq2 bioconductor-ebseq
RUN conda install -y -c bcbio bx-python
RUN conda install -y r-reshape r-rpart r-rpart.plot r-rocr r-caret r-optparse r-lattice r-gridbase \
                     r-e1071 r-randomforest r-partykit r-ipred r-domc r-nnet r-rose r-proc \
                     r-mlmetrics r-pheatmap r-emt r-stringi=1.4.6

ENV PATH=$CONDA_PREFIX/bin:$PATH
RUN mkdir ~/.pip && echo "[global]\nindex-url = https://pypi.tuna.tsinghua.edu.cn/simple" > ~/.pip/pip.conf
RUN pip install pandas matplotlib==2.2.3 scikit-image==0.14.3 scikit-learn psutil pulp networkx==2.2 PyWavelets==1.0.3 \
                biopython==1.76 pybedtools parasail PyVCF
RUN R -e "install.packages('tidyr', repos='https://mirrors.tuna.tsinghua.edu.cn/CRAN/')"
RUN R -e "install.packages('valr', repos='https://mirrors.tuna.tsinghua.edu.cn/CRAN/')"

# generic installation
RUN git clone https://hub.fastgit.org/Magdoll/cDNA_Cupcake.git $IFLAS_HOME/software/cDNA_Cupcake && \
#RUN git clone https://github.com/Magdoll/cDNA_Cupcake.git $IFLAS_HOME/software/cDNA_Cupcake && \
    cd $IFLAS_HOME/software/cDNA_Cupcake && git checkout Py2_v8.7.x && \
    $CONDA_PREFIX/bin/python setup.py build && $CONDA_PREFIX/bin/python setup.py install

RUN $CONDA_PREFIX/bin/cpanm Log::Log4perl File::Which && \
	git clone https://hub.fastgit.org/BioInf-Wuerzburg/proovread.git $IFLAS_HOME/software/proovread && \
#	git clone https://github.com/BioInf-Wuerzburg/proovread.git $IFLAS_HOME/software/proovread && \
	make -C $IFLAS_HOME/software/proovread
ENV PATH=$IFLAS_HOME/software/proovread/bin:$PATH

RUN git clone https://hub.fastgit.org/CrazyHsu/SQANTI.git $IFLAS_HOME/software/sqanti && \
#RUN git clone https://github.com/CrazyHsu/SQANTI.git $IFLAS_HOME/software/sqanti && \
	chmod +x $IFLAS_HOME/software/sqanti/sqanti_qc.py
ENV PATH=$IFLAS_HOME/software/sqanti:$PATH

RUN git clone https://hub.fastgit.org/CrazyHsu/SpliceGrapher_packages.git $IFLAS_HOME/software/SpliceGrapher_packages
RUN tar -xf $IFLAS_HOME/software/SpliceGrapher_packages/PyML-0.7.14.tar.gz -C $IFLAS_HOME/software
WORKDIR $IFLAS_HOME/software/PyML-0.7.14
RUN $CONDA_PREFIX/bin/python setup.py build && $CONDA_PREFIX/bin/python setup.py install

RUN tar -xf $IFLAS_HOME/software/SpliceGrapher_packages/SpliceGrapher-0.2.7.tgz -C $IFLAS_HOME/software
WORKDIR $IFLAS_HOME/software/SpliceGrapher-0.2.7
RUN $CONDA_PREFIX/bin/python setup.py build && $CONDA_PREFIX/bin/python setup.py install
RUN rm -rf $IFLAS_HOME/software/SpliceGrapher_packages

#RUN wget --no-check-certificate https://sourceforge.net/projects/pyml/files/PyML-0.7.14.tar.gz -O $IFLAS_HOME/software/PyML-0.7.14.tar.gz && \
#	tar -xf $IFLAS_HOME/software/PyML-0.7.14.tar.gz -C $IFLAS_HOME/software && rm -rf $IFLAS_HOME/software/PyML-0.7.14.tar.gz
#WORKDIR $IFLAS_HOME/software/PyML-0.7.14
#RUN $CONDA_PREFIX/bin/python setup.py build && $CONDA_PREFIX/bin/python setup.py install

##RUN $CONDA_PREFIX/bin/pip install -i https://pypi.anaconda.org/adarsh/simple pyml
#RUN wget --no-check-certificate https://sourceforge.net/projects/splicegrapher/files/SpliceGrapher-0.2.7.tgz -O $IFLAS_HOME/software/SpliceGrapher-0.2.7.tgz && \
#	tar -xf $IFLAS_HOME/software/SpliceGrapher-0.2.7.tgz -C $IFLAS_HOME/software && rm -rf $IFLAS_HOME/software/SpliceGrapher-0.2.7.tgz
#WORKDIR $IFLAS_HOME/software/SpliceGrapher-0.2.7
#RUN $CONDA_PREFIX/bin/python setup.py build && $CONDA_PREFIX/bin/python setup.py install

# RUN conda install -y -c bioconda ucsc-genepredtobed

RUN git clone https://hub.fastgit.org/CrazyHsu/Cogent.git $IFLAS_HOME/software/Cogent && \
#RUN git clone https://github.com/Magdoll/Cogent.git $IFLAS_HOME/software/Cogent && \
    cd $IFLAS_HOME/software/Cogent && git checkout Py2.7_4.0.x && git submodule update --init --recursive && \
    cd Complete-Striped-Smith-Waterman-Library/src && make
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$IFLAS_HOME/software/Cogent/Complete-Striped-Smith-Waterman-Library/src
ENV PYTHONPATH=$PYTHONPATH:$IFLAS_HOME/software/Cogent/Complete-Striped-Smith-Waterman-Library/src
WORKDIR $IFLAS_HOME/software/Cogent
RUN python setup.py build && python setup.py install

WORKDIR $IFLAS_HOME